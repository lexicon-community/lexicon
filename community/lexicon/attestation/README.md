# community.lexicon.attestation

A collection of types enabling record signatures and attestation.

> The act of attesting; testimony; witness; a solemn or official declaration, verbal or written, in support of a fact; evidence. The truth appears from the attestation of witnesses, or of the proper officer. The subscription of a name to a writing as a witness, is an attestation. 

# Background and Context

DID documents contain cryptographic key data[^didmethodkey] that can be used to create signatures. From the [did-core](https://www.w3.org/TR/did-core/) spec:

> A DID document can express verification methods, such as cryptographic public keys, which can be used to authenticate or authorize interactions with the DID subject or associated parties.

These are currently used in AT Protocol for repository signatures. The typical behavior is to create a did-method-key entry in `verificationMethods` with the ID fragment `#atproto` resulting in a verification method with the ID `did:plc:cbk...fq2#atproto`.

# NSID community.lexicon.attestation

## Type: Signature

The `community.lexicon.attestation.defs#signature` type contains signature payloads with the following required fields:

* `signature` (`string`) -- The signature of the record, see [Creating Signatures](#creating-signatures)
* `issuer` (`string,format:did`) -- The identity that created the signature.

Additionally, the following optional fields are defined:

* `notBefore` (`timestamp`) - An optional start time that a signature is valid for.
* `notAfter` (`timestamp`)  - Anoptional end time that a signature is valid for.
* `revocation` (`string,uri`)  - A reference to another record or structure that will exist if the signature is revoked and contains revocation affirmation.
* `signedAt` (`timestamp`)  - A timestamp for when the signature was created.

Any additional fields are included as-is in the creation of the signature.

## Type: Revocation

The `community.lexicon.attestation.revocation` type is a record used to create multi-factor verification that a signature is still valid.

* `revoked` (required, `bool`) -- A boolean value that is `true` if the signature referenced by this record has been revoked and is no longer valid. `false` if the signature is valid and has not been revoked.
* `message` (`string`) -- An optional message by the revocation record holder.

## Trait: Signed

This NSID includes the trait type `community.lexicon.attestation.signed`. This record trait is used to create typed attributes for records that include the signature collections.

***Note***: Traits are not a formally adopted pattern. Implementation and use may vary.

# Creating Signatures

A signature is generated by composing a DAG-CBOR representation of the record and applying the signing function defiined by a verification method.

The signed content does not include the "signatures" attribute and also includes a "$sig" object containing additional information used to secure the signature. The "issuer," "did," and "collection" attributes are required to provide scope to the signature and prevent duplication of the signature in other repositories or collections. The "issuer" element is specifically used to resolve the verification method to validate the signature.

Signatures are appended with the last signature of an issuer being validated. This behavior allows issuers to append and replace signatures with a fixed time window for each to be valid. Applications decide whether or not to keep signature histories on records.

## Example

Given a DID document for an issuer that contains an `id` and `verificationMethods`:

```json
{
  "did": "did:web:issuer.com",
  "verificationMethod": [
    {
      "id": "did:web:issuer.com#sigs",
      "type": "Multikey",
      "controller": "did:web:issuer.com",
      "publicKeyMultibase": "zQ3shZ8CYPaHWkvBspJNXNgXTJDyo3azaNRtUyHyLbefWfsrR"
    }
  ]
}
```

Where the `` is derived from

```pem
-----BEGIN PRIVATE KEY-----
MIGEAgEAMBAGByqGSM49AgEGBSuBBAAKBG0wawIBAQQgmJmy27osUE+ypt+n7ZgQ
/sxV0vK+fCRzPjqBByPXIxKhRANCAASuDEN2EXUQPELxezu0gm/59uLAzNxMduAe
WRZtmkot+kltNYRvFPqfQU3263We1XwG06e6gucQ1OiasiTgig+E
-----END PRIVATE KEY-----
```

The followed signed record would be produced:

```json
{
  "$type": "contact",
  "name": "Alice",
  "signatures": [
    {
      "issuer": "did:web:issuer.com",
      "signature": "MEUCIHjU0jdaNvUYUokTNVTiuhQJd65n28W5g5lAP_oQar6fAiEAoZMYOWSK9Inf-JvyE6ehvDlwNt6_sNGEde77D-h35GU="
    }
  ]
}
```

# Verifying Signatures

Any application or system using the record to make decisions must validate signatures using this process:

* Fail validation if a signature is outside of "notBefore" or "notAfter"
* Fail validation if a signature block has a "did" attribute that does not match the AT-URI
* Fail validation if a signature block has a "collection" attribute that does not match the AT-URI
* Fail validation if the issuer cannot be resolved
* Fail validation if the issuer key cannot be not resolved
* Fail validation if the computed signature does not match the given signature.
* Fail validation if a revocation entry exists and the value of that entry matches the revocation type where the "revoked" value is true.

## Example

Given the record:

```json
{
  "$type": "status",
  "status": "Everything is fine",
  "signatures": [
    {
      "signedAt": "2024-12-07T18:43:27.62Z",
      "revocation": "at://did:web:issuer.com/community.lexicon.attestation.revocation/jhrcw9j73e",
      "headlines": [
        "Global tech crackdown Mon, 20 Dec 2021 14:58:18 +0000",
        "COVID-19 series: The year of the vaccine Tue, 24 Aug 2021 14:09:30 +0000"
      ],
      "issuer": "did:web:issuer.com",
      "signature": "MEUCIBGxcOrsVXQ4uQa2anZMI0VTyJ2bgbuOfZfnDV4ivfXcAiEAsu_iWULHkLseRk0Nj4-6ws7GOrUppQ8s2zciV7L1iCE="
    }
  ]
}
```

A lookup of the issuer would reveal the DID document:

```json
{
  "did": "did:web:issuer.com",
  "verificationMethod": [
    {
      "id": "did:web:issuer.com#sigs",
      "type": "Multikey",
      "controller": "did:web:issuer.com",
      "publicKeyMultibase": "zQ3shnPXuioEoyCktAXfq6CAtDr7cgbADRiGbrLP8FpANNK6M"
    }
  ]
}
```

Each of the verification methods would be attempted against the signature and would eventually succeed. The additional content in the signature structure is incorporated into the signature creation processing, allowing issuers to include relevant structures and apply traits as needed.

[^didmethodkey]: [https://w3c-ccg.github.io/did-method-key/](https://w3c-ccg.github.io/did-method-key/)
